<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>classes &mdash; Siman 2.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Siman 2.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for classes</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Classes used in siman</span>
<span class="sd">TODO:</span>
<span class="sd">1. Please  combine calculate_nbands(), calc_kspacings(), magmom filling in make incar  with actualize_set() </span>
<span class="sd">2. split make_incar_and_copy_all() into make_incar() and copy_calc_files_to_cluster()</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">header</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">header</span>
<span class="kn">from</span> <span class="nn">functions</span> <span class="kn">import</span> <span class="p">(</span><span class="n">read_vectors</span><span class="p">,</span> <span class="n">read_list</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">local_surrounding</span><span class="p">,</span> <span class="n">xred2xcart</span><span class="p">,</span> <span class="n">xcart2xred</span><span class="p">,</span> <span class="n">element_name_inv</span><span class="p">,</span> <span class="n">calculate_voronoi</span><span class="p">)</span>



<span class="k">class</span> <span class="nc">empty_struct</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="Structure"><a class="viewcode-back" href="../index.html#classes.Structure">[docs]</a><span class="k">class</span> <span class="nc">Structure</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;This class includes only structure related information such as primitive vectors, coordinates, forces and so on&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">des</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xcart</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xred</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="Calculation"><a class="viewcode-back" href="../index.html#classes.Calculation">[docs]</a><span class="k">class</span> <span class="nc">Calculation</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Main class of siman. Objects of this class contain all information about first-principles calculation&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inset</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="c1">#super(CalculationAbinit, self).__init__()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;noname&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">inset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">Structure</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;1.Initialized&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;input&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span>
        <span class="s2">&quot;input_geo&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span>
        <span class="s2">&quot;potential&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span>
        <span class="s2">&quot;output&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>


<div class="viewcode-block" id="Calculation.read_geometry"><a class="viewcode-back" href="../index.html#classes.Calculation.read_geometry">[docs]</a>    <span class="k">def</span> <span class="nf">read_geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads geometrical data from filename file in abinit format&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;input_geo&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;input_geo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>



        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
            <span class="c1">#For large files can be time consuming</span>
            <span class="n">memfile</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">gen_words</span> <span class="o">=</span> <span class="n">memfile</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">des</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>  
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">memfile</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                <span class="k">if</span> <span class="s1">&#39;des&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span> 
                    <span class="k">print</span> <span class="n">line</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">des</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;des &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;;&#39;</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">build</span> <span class="o">=</span> <span class="n">empty_struct</span><span class="p">()</span>                
                <span class="k">if</span> <span class="s1">&#39;BEGIN BUILD INFORMATION&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">File contain build information! Start to read&quot;</span>
                    <span class="c1"># self.build = Structure()</span>
                    <span class="c1"># # self.build.rprimd = None</span>
                    <span class="c1"># # self.build.xred = None</span>
                    <span class="c1"># # self.build.xcart = None</span>
                    <span class="c1"># # self.build.des = None</span>
                    <span class="c1"># # self.build.name = None</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">calctype</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;calctype&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">a_c_conv</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;a_c_conv&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">build_natom</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;build_natom&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">build_acell</span> <span class="o">=</span> <span class="n">read_vectors</span><span class="p">(</span><span class="s2">&quot;build_acell&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">build_rprim</span> <span class="o">=</span> <span class="n">read_vectors</span><span class="p">(</span><span class="s2">&quot;build_rprim&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">build_xred</span> <span class="o">=</span> <span class="n">read_vectors</span><span class="p">(</span><span class="s2">&quot;build_xred&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">build_natom</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">build_ntypat</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;build_ntypat&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">build_typat</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;build_typat&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">build_natom</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">build_znucl</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;build_znucl&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">build_ntypat</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">hkl1</span> <span class="o">=</span> <span class="n">read_vectors</span><span class="p">(</span><span class="s2">&quot;hkl1&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">uvw1</span> <span class="o">=</span> <span class="n">read_vectors</span><span class="p">(</span><span class="s2">&quot;uvw1&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">uvw2</span> <span class="o">=</span> <span class="n">read_vectors</span><span class="p">(</span><span class="s2">&quot;uvw2&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">uvw3</span> <span class="o">=</span> <span class="n">read_vectors</span><span class="p">(</span><span class="s2">&quot;uvw3&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">mul</span>  <span class="o">=</span> <span class="n">read_vectors</span><span class="p">(</span><span class="s2">&quot;mul&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">nadded</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;nadded&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#total number of added atoms after building structure</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">listadded</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;listadded&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">nadded</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span> <span class="c1">#list of added atoms corresponding to xred </span>

                    <span class="k">print</span> <span class="s2">&quot;Build information has been read</span><span class="se">\n</span><span class="s2">&quot;</span>





            <span class="c1">#sys.exit()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">useable</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1">#Read total number of atoms</span>
            <span class="c1">#Programm nznucl, since We will have more impurity atoms of different types</span>
            <span class="n">command</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;grep -w -m 1 &quot;natom &quot; &quot;&quot;&quot;</span><span class="o">+</span><span class="n">filename</span>
            <span class="n">s1</span><span class="o">=</span><span class="n">runBash</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="c1"># print command</span>
            <span class="c1"># print s1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">natom_str</span> <span class="o">=</span> <span class="n">s1</span>
            <span class="k">if</span> <span class="n">s1</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">natom</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;&quot;&quot;Warning! In filename &quot;&quot;&quot;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s2">&quot;&quot;&quot; not found natom! set to zero.</span>
<span class="s2">                It is very likly that other parameters was not </span>
<span class="s2">                found too, Calculation completly not useable!!!&quot;&quot;&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">s1</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span> 

            <span class="bp">self</span><span class="o">.</span><span class="n">acell</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;acell&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rprim</span> <span class="o">=</span> <span class="n">read_vectors</span><span class="p">(</span><span class="s2">&quot;rprim&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprim</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">acell</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>         <span class="c1">#Calculate rprimd</span>
            <span class="c1">#Determine reciprocal vectors</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recip</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  <span class="p">);</span> <span class="c1">#volume</span>
            <span class="c1">#print vol</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recip</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>   <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span>   <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recip</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>   <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>   <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recip</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>   <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>   <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">recip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">recip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">vol</span><span class="p">;</span>
            <span class="c1">#print self.recip</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ntypat</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;ntypat&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">typat</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;typat&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">typat</span><span class="p">:</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Error; 0 in typat is not allowed&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">nznucl</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">typ</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ntypat</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nznucl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>  <span class="bp">self</span><span class="o">.</span><span class="n">typat</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span> <span class="p">)</span>


            <span class="bp">self</span><span class="o">.</span><span class="n">znucl</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;znucl&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntypat</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xcart</span> <span class="o">=</span> <span class="n">read_vectors</span><span class="p">(</span><span class="s2">&quot;xcart&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">xred</span> <span class="o">=</span> <span class="n">read_vectors</span><span class="p">(</span><span class="s2">&quot;xred&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
            <span class="c1">#print self.xred</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xred</span> <span class="o">==</span> <span class="p">[</span><span class="bp">None</span><span class="p">]:</span>
                <span class="k">print</span> <span class="s2">&quot;Convert xcart to xred&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xred</span> <span class="o">=</span> <span class="n">xcart2xred</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xcart</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xcart</span> <span class="o">==</span> <span class="p">[</span><span class="bp">None</span><span class="p">]:</span>
                <span class="k">print</span> <span class="s2">&quot;Convert xred to xcart&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xcart</span> <span class="o">=</span> <span class="n">xred2xcart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xred</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">hex_a</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;hex_a&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hex_c</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;hex_c&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">len_units</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;len_units&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">gbpos</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;gbpos&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>



            <span class="bp">self</span><span class="o">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">Structure</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;.init&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xcart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xcart</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xred</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">rprimd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rprimd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">recip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recip</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vol</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">znucl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">znucl</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">nznucl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nznucl</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">typat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">typat</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">ntypat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntypat</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">natom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span> 



            <span class="n">vel</span> <span class="o">=</span> <span class="n">read_vectors</span><span class="p">(</span><span class="s2">&quot;vel&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>
            <span class="c1"># print vel</span>
            <span class="k">if</span> <span class="n">vel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">vel</span> <span class="o">=</span> <span class="n">vel</span>

            <span class="c1">#read magnetic states; name of vasp variable</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">magmom</span> <span class="o">=</span> <span class="n">read_list</span><span class="p">(</span><span class="s2">&quot;magmom&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">gen_words</span><span class="p">)</span>







            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;2.Geometry has been read&quot;</span>



        <span class="c1">#file.close();</span>

        <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;If no warnings, geometry has been succesfully read from file &quot;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s2">&quot; </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span></div>





<div class="viewcode-block" id="Calculation.write_geometry"><a class="viewcode-back" href="../index.html#classes.Calculation.write_geometry">[docs]</a>    <span class="k">def</span> <span class="nf">write_geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geotype</span> <span class="o">=</span> <span class="s2">&quot;init&quot;</span><span class="p">,</span> <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">override</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes geometrical data to self.path[&quot;input_geo&quot;]&quot;&quot;&quot;</span>
        <span class="n">geo_dic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">geofile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;input_geo&quot;</span><span class="p">]</span>
        <span class="n">geo_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">geofile</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">geo_exists</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">override</span><span class="p">:</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Warning! File &quot;</span><span class="o">+</span><span class="n">geofile</span><span class="o">+</span><span class="s2">&quot; was replaced</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span> 
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Error! File &quot;</span><span class="o">+</span><span class="n">geofile</span><span class="o">+</span><span class="s2">&quot; exists. To replace it set parameter override</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span> 
                <span class="k">return</span> <span class="bp">False</span>
                <span class="c1">#raise RuntimeError</span>
        <span class="k">print</span> <span class="s2">&quot;geofile name, classes:&quot;</span><span class="p">,</span>  <span class="n">geofile</span>
        <span class="k">print</span> <span class="s2">&quot;folder :&quot;</span><span class="p">,</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">geofile</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">geofile</span><span class="p">)):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">geofile</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">geotype</span> <span class="o">==</span> <span class="s2">&quot;init&quot;</span><span class="p">:</span> <span class="c1">#write initial structure</span>
            <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span>
        <span class="k">elif</span> <span class="n">geotype</span> <span class="o">==</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s1">&#39;natom&#39;</span><span class="p">):</span>  <span class="n">st</span><span class="o">.</span><span class="n">natom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">natom</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s1">&#39;ntypat&#39;</span><span class="p">):</span> <span class="n">st</span><span class="o">.</span><span class="n">ntypat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">ntypat</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s1">&#39;typat&#39;</span><span class="p">):</span> <span class="n">st</span><span class="o">.</span><span class="n">typat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">typat</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s1">&#39;znucl&#39;</span><span class="p">):</span> <span class="n">st</span><span class="o">.</span><span class="n">znucl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">znucl</span> 
        <span class="k">else</span><span class="p">:</span> <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Error! Unknown geotype </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span> <span class="k">raise</span> <span class="ne">RuntimeError</span>                                  

        <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">natom</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">xred</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">znucl</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">max</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="p">):</span> 
            <span class="k">print</span> <span class="s2">&quot;Error! write_geometry: check your arrays.</span><span class="se">\n\n</span><span class="s2">&quot;</span> 



        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;input_geo&quot;</span><span class="p">],</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;des &quot;</span><span class="o">+</span><span class="n">description</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;len_units &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">len_units</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;hex_a &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hex_a</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;hex_c &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hex_c</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gbpos</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gbpos</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;gbpos &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gbpos</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;version &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;acell 1 1 1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;natom  &quot;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">natom</span><span class="p">)</span> <span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ntypat &quot;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">ntypat</span><span class="p">)</span> <span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;znucl  &quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">znucl</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">typat  &quot;</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>  <span class="p">);</span> <span class="n">i</span><span class="o">+=</span><span class="mi">1</span><span class="p">;</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">rprim  &quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.12f</span><span class="s2"> </span><span class="si">%.12f</span><span class="s2"> </span><span class="si">%.12f</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  <span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;xred  &quot;</span><span class="p">)</span>
            <span class="c1">#print st.xred</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">xred</span><span class="p">)</span> <span class="o">!=</span> <span class="n">st</span><span class="o">.</span><span class="n">natom</span><span class="p">:</span> <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Warning! write_geometry(): xred is empty or overfull</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span><span class="k">raise</span> <span class="ne">RuntimeError</span> 
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">xred</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.12f</span><span class="s2"> </span><span class="si">%.12f</span><span class="s2"> </span><span class="si">%.12f</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  <span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;xcart  &quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">)</span> <span class="o">!=</span> <span class="n">st</span><span class="o">.</span><span class="n">natom</span><span class="p">:</span> 
                <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Warning! write_geometry(): xcart is empty or overfull, I make it from xred</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span><span class="c1">#raise RuntimeError</span>
                <span class="n">st</span><span class="o">.</span><span class="n">xcart</span> <span class="o">=</span> <span class="n">xred2xcart</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">xred</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">)</span> 
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">xcart</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.12f</span><span class="s2"> </span><span class="si">%.12f</span><span class="s2"> </span><span class="si">%.12f</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  <span class="p">)</span>


            <span class="c1">#Write build information</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">build</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n\n</span><span class="s2">#BEGIN BUILD INFORMATION!!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1">#print self.build.__dict__</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">==</span> <span class="p">[</span><span class="bp">None</span><span class="p">]:</span> <span class="k">continue</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="n">val</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">val</span><span class="p">))</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="c1">#print temp</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">temp</span> <span class="p">))</span>  <span class="c1"># iterable</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>  <span class="p">)</span>                    <span class="c1"># not iterable</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">#END BUILD INFORMATION!!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


        <span class="k">return</span> <span class="bp">True</span></div></div>







<div class="viewcode-block" id="CalculationAbinit"><a class="viewcode-back" href="../index.html#classes.CalculationAbinit">[docs]</a><span class="k">class</span> <span class="nc">CalculationAbinit</span><span class="p">(</span><span class="n">Calculation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;docstring for CalculationAbinit&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>









<div class="viewcode-block" id="CalculationVasp"><a class="viewcode-back" href="../index.html#classes.CalculationVasp">[docs]</a><span class="k">class</span> <span class="nc">CalculationVasp</span><span class="p">(</span><span class="n">Calculation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Methods for calculations made using VASP DFT code&quot;&quot;&quot;</span>



<div class="viewcode-block" id="CalculationVasp.read_poscar"><a class="viewcode-back" href="../index.html#classes.CalculationVasp.read_poscar">[docs]</a>    <span class="k">def</span> <span class="nf">read_poscar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read POSCAR file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;input_geo&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;input_geo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">len_units</span> <span class="o">=</span> <span class="s1">&#39;Angstrom&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hex_a</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hex_c</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gbpos</span> <span class="o">=</span> <span class="bp">None</span>


        <span class="c1">#Determine version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Trying to find version at the end of filename POSCAR-v ...&#39;</span><span class="p">)</span>
            <span class="n">ver</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> 
            <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;OK</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Trying to find version at the begenning of filename v.POSCAR...&#39;</span><span class="p">)</span>
            <span class="n">ver</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;OK</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span>    



        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">ver</span>
        <span class="c1"># except:</span>
        <span class="c1">#     pass</span>
        <span class="c1"># print self.version, &#39;version&#39;</span>



        <span class="bp">self</span><span class="o">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">Structure</span><span class="p">()</span>
        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># print self.name, &quot;self.name&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">des</span> <span class="o">=</span> <span class="n">name</span>
            <span class="c1"># st.name = self.name</span>

            <span class="n">mul</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span> <span class="p">)</span>
            <span class="c1"># print &#39;mul&#39;, mul</span>


            <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">vec</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">mul</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">mul</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">mul</span><span class="p">])</span> <span class="p">)</span>

            <span class="n">st</span><span class="o">.</span><span class="n">nznucl</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                <span class="n">st</span><span class="o">.</span><span class="n">nznucl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">int</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>  <span class="p">)</span>

            <span class="n">type_of_coordinates</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

            <span class="n">st</span><span class="o">.</span><span class="n">xred</span> <span class="o">=</span> <span class="p">[]</span>


            <span class="k">if</span> <span class="s2">&quot;Car&quot;</span> <span class="ow">in</span> <span class="n">type_of_coordinates</span><span class="p">:</span>
                <span class="c1"># print &quot;Warning! may be obsolete!!! and incorrect&quot;</span>
                <span class="c1"># f.write(&quot;Cartesian\n&quot;)</span>
                <span class="c1"># for xcart in zxcart:</span>
                <span class="c1">#     for x in xcart:</span>
                <span class="c1">#         f.write(str(x[0]*to_ang)+&quot; &quot;+str(x[1]*to_ang)+&quot; &quot;+str(x[2]*to_ang))</span>
                <span class="c1">#         f.write(&quot;\n&quot;)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span>
                
            <span class="k">elif</span> <span class="s2">&quot;dir&quot;</span> <span class="ow">in</span> <span class="n">type_of_coordinates</span> <span class="ow">or</span> <span class="s1">&#39;Dir&#39;</span> <span class="ow">in</span> <span class="n">type_of_coordinates</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">nz</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">nznucl</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz</span><span class="p">):</span>
                        <span class="n">vec</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">xred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="mi">2</span><span class="p">])])</span> <span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">xcart</span> <span class="o">=</span> <span class="n">xred2xcart</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">xred</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">)</span>

            <span class="k">elif</span> <span class="s1">&#39;None&#39;</span> <span class="ow">in</span> <span class="n">type_of_coordinates</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Error! The type of coordinates should be &#39;car&#39; or &#39;dir&#39; &quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">NameError</span>


            <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;First line should contain names of elements; The line is &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; you could use ! to add comment after name+</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;Species order:&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;I detect that input file was generated by cif2cell</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


            <span class="n">st</span><span class="o">.</span><span class="n">znucl</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">elname</span> <span class="ow">in</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                <span class="n">st</span><span class="o">.</span><span class="n">znucl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">element_name_inv</span><span class="p">(</span><span class="n">elname</span><span class="p">)</span> <span class="p">)</span>
            <span class="c1"># print_and_log(&#39;znucl is &#39;)</span>



            <span class="n">st</span><span class="o">.</span><span class="n">natom</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">xred</span><span class="p">)</span>

            <span class="n">st</span><span class="o">.</span><span class="n">ntypat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">znucl</span><span class="p">)</span>

            <span class="n">st</span><span class="o">.</span><span class="n">typat</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">nz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">nznucl</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz</span><span class="p">):</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">typat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1">#Determine reciprocal vectors</span>
            <span class="n">st</span><span class="o">.</span><span class="n">recip</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">st</span><span class="o">.</span><span class="n">vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  <span class="p">);</span> <span class="c1">#volume</span>
            <span class="c1">#print vol</span>
            <span class="n">st</span><span class="o">.</span><span class="n">recip</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>   <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span> <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span>   <span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">recip</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>   <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span> <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>   <span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">recip</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>   <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span> <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>   <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">recip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>  <span class="n">st</span><span class="o">.</span><span class="n">recip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">st</span><span class="o">.</span><span class="n">vol</span><span class="p">;</span>

                <span class="c1"># if hasattr(self.init, &#39;vel&#39;):</span>
                <span class="c1">#     print &quot;I write to POSCAR velocity as well&quot;</span>
                <span class="c1">#     f.write(&quot;Cartesian\n&quot;)</span>
                <span class="c1">#     for v in self.init.vel:</span>
                <span class="c1">#         f.write( &#39;%.12f %.12f %.12f\n&#39;%(v[0]*to_ang, v[1]*to_ang, v[2]*to_ang) )</span>

        <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;The following Z were read = &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">znucl</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>


        <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;POSCAR was read</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span></div>
    

    <span class="k">def</span> <span class="nf">check_kpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">to_ang_local</span> <span class="o">=</span> <span class="n">to_ang</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;Ang&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">len_units</span><span class="p">:</span>
                <span class="n">to_ang_local</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="c1">#print &quot;units angs&quot;</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Warning! no len_units for &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot; calculation, I use Bohr </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> 
        <span class="n">N_from_kspacing</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># print self.set.vasp_params[&#39;KSPACING&#39;]</span>
        <span class="k">print</span> 
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">N_from_kspacing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">recip</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">to_ang_local</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s1">&#39;KSPACING&#39;</span><span class="p">])</span> <span class="p">)</span>
        <span class="c1">#print &quot;Vector length is:&quot;, (np.linalg.norm(self.rprimd[0]), &quot;Bohr&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">kpoints_file</span>  <span class="o">==</span> <span class="bp">False</span><span class="p">:</span><span class="c1">#self.set.vasp_params[&#39;KSPACING&#39;]:</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">N_from_kspacing</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">ngkpt</span><span class="p">:</span>
            <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">ngkpt</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">N_from_kspacing</span>


        <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Kpoint   mesh is: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;The actual k-spacings are &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_kspacings</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">N_from_kspacing</span>


<div class="viewcode-block" id="CalculationVasp.write_structure"><a class="viewcode-back" href="../index.html#classes.CalculationVasp.write_structure">[docs]</a>    <span class="k">def</span> <span class="nf">write_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_of_output_file</span><span class="p">,</span> <span class="n">type_of_coordinates</span> <span class="o">=</span> <span class="s1">&#39;dir&#39;</span><span class="p">,</span> <span class="n">option</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">prevcalcver</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;init&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates POSCAR file</span>
<span class="sd">           type_of_coordinates - &#39;direct&#39; (xred) or &#39;cartesian&#39; (xcart)</span>
<span class="sd">           option -inheritance option</span>
<span class="sd">           prevcalcver - ver of first calc in calc list; for first None</span>
<span class="sd">           state - &#39;init&#39; or &#39;end&#39; </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#units</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;ang&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">len_units</span> <span class="ow">or</span> <span class="s2">&quot;Ang&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">len_units</span><span class="p">:</span> 
                <span class="k">global</span> <span class="n">to_ang</span><span class="p">;</span> <span class="n">to_ang</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span> <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Conversion multiplier to_ang is &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">to_ang</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;inherit_xred&#39;</span> <span class="ow">and</span> <span class="s1">&#39;car&#39;</span> <span class="ow">in</span> <span class="n">type_of_coordinates</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span> 

        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;inherit_xred&#39;</span> <span class="ow">and</span> <span class="n">prevcalcver</span><span class="p">:</span> <span class="n">type_of_coordinates</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span> <span class="c1"># do not write xred or xcart if they will be transfered on cluster</span>
        
        <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span>
        
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;init&#39;</span><span class="p">:</span>
            <span class="n">st</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;end&#39;</span><span class="p">:</span>
            <span class="n">st</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">RuntimeError</span> 
        
        <span class="n">rprimd</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">rprimd</span>
        <span class="n">xred</span>   <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">xred</span>
        <span class="n">xcart</span>  <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">xcart</span>
        <span class="n">typat</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">typat</span>  
        <span class="n">znucl</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">znucl</span>

        
        <span class="k">print</span> 
        <span class="sd">&quot;&quot;&quot;1. Generate correct nznucl and zxred and zxcart&quot;&quot;&quot;</span>
        <span class="n">zxred</span>  <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">znucl</span><span class="p">]</span>
        <span class="n">zxcart</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">znucl</span><span class="p">]</span>
        <span class="c1"># nznucl = []</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">typat</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xred</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">xred</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xcart</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span>
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">xr</span><span class="p">,</span> <span class="n">xc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">typat</span><span class="p">,</span> <span class="n">xred</span><span class="p">,</span> <span class="n">xcart</span><span class="p">):</span>
            <span class="c1"># print &quot;t &quot;, t, xr</span>
            <span class="n">zxred</span><span class="p">[</span> <span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xr</span><span class="p">)</span>
            <span class="n">zxcart</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xc</span><span class="p">)</span>
        
        <span class="n">nznucl</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">xred</span><span class="p">)</span> <span class="k">for</span> <span class="n">xred</span> <span class="ow">in</span> <span class="n">zxred</span><span class="p">]</span>

        <span class="c1"># print znucl, typat</span>
        <span class="c1"># print zxred</span>
        <span class="c1"># print nznucl</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">runBash</span><span class="p">(</span><span class="s2">&quot;mkdir -p &quot;</span><span class="o">+</span><span class="n">path</span><span class="p">)</span> <span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">name_of_output_file</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Writes structure (POSCAR) in VASP format &quot;&quot;&quot;</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">%18.16f</span><span class="s1"> </span><span class="si">%18.16f</span><span class="s1"> </span><span class="si">%18.16f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">rprimd</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">to_ang</span><span class="p">,</span><span class="n">rprimd</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">to_ang</span><span class="p">,</span><span class="n">rprimd</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">to_ang</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nznucl</span><span class="p">:</span>    
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;car&quot;</span> <span class="ow">in</span> <span class="n">type_of_coordinates</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;Warning! may be obsolete!!! and incorrect&quot;</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Cartesian</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">xcart</span> <span class="ow">in</span> <span class="n">zxcart</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xcart</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">to_ang</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">to_ang</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">to_ang</span><span class="p">))</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">,</span> <span class="s1">&#39;vel&#39;</span><span class="p">):</span>
                    <span class="k">print</span> <span class="s2">&quot;I write to POSCAR velocity as well&quot;</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Cartesian</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">vel</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39;  {:18.16f}  {:18.16f}  {:18.16f}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">to_ang</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">to_ang</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">to_ang</span><span class="p">)</span> <span class="p">)</span>

            <span class="k">elif</span> <span class="s2">&quot;dir&quot;</span> <span class="ow">in</span> <span class="n">type_of_coordinates</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Direct</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">xred</span> <span class="ow">in</span> <span class="n">zxred</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xred</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  {:18.16f}  {:18.16f}  {:18.16f}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;None&#39;</span> <span class="ow">in</span> <span class="n">type_of_coordinates</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Error! The type of coordinates should be &#39;car&#39; or &#39;dir&#39; &quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">NameError</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;POSCAR was generated</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span></div>



<div class="viewcode-block" id="CalculationVasp.add_potcar"><a class="viewcode-back" href="../index.html#classes.CalculationVasp.add_potcar">[docs]</a>    <span class="k">def</span> <span class="nf">add_potcar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Should be run for the first calculation only&quot;&quot;&quot;</span>
        <span class="c1">#Add POTCAR</span>
        <span class="c1">#try:</span>
        <span class="c1">#    shutil.copy2(self.set.potdir[0]+&#39;/POTCAR&#39;,self.dir)</span>
        <span class="c1">#except IOError:</span>
        <span class="c1">#    runBash(&quot;gunzip &quot;+self.set.potdir[0]+&quot;/POTCAR.Z&quot;)</span>

        <span class="n">path_to_potcar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="s1">&#39;/POTCAR&#39;</span>
        <span class="n">potcar_files</span>   <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">znucl</span><span class="p">:</span>
            <span class="n">potcar_files</span> <span class="o">+=</span> <span class="n">path_to_potentials</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">potdir</span><span class="p">[</span> <span class="nb">int</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="p">]</span><span class="o">+</span><span class="s2">&quot;/POTCAR &quot;</span>

        <span class="n">runBash</span><span class="p">(</span><span class="s2">&quot;cat &quot;</span><span class="o">+</span><span class="n">potcar_files</span><span class="o">+</span><span class="s2">&quot; &gt;&quot;</span><span class="o">+</span><span class="n">path_to_potcar</span><span class="p">)</span>

        <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;POTCAR files: &quot;</span><span class="o">+</span><span class="n">potcar_files</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>        
        <span class="k">return</span></div>


<div class="viewcode-block" id="CalculationVasp.calculate_nbands"><a class="viewcode-back" href="../index.html#classes.CalculationVasp.calculate_nbands">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_nbands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Should be run after add_potcar()&quot;&quot;&quot;</span>
        <span class="c1">#1 add additional information to set</span>

        <span class="n">path_to_potcar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="s1">&#39;/POTCAR&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">zval</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">print</span> <span class="n">path_to_potcar</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_potcar</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;ZVAL&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="c1"># print line</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">zval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">5</span><span class="p">]))</span>
        
        <span class="k">try</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">add_nbands</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">add_nbands</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">add_nbands</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">tve</span> <span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">ntypat</span><span class="p">):</span>
                <span class="c1"># print self.init.zval</span>
                <span class="n">tve</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">zval</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">nznucl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nbands</span> <span class="o">=</span> <span class="nb">int</span> <span class="p">(</span> <span class="nb">round</span> <span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">tve</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">add_nbands</span> <span class="p">)</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s1">&#39;NBANDS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbands</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="CalculationVasp.actualize_set"><a class="viewcode-back" href="../index.html#classes.CalculationVasp.actualize_set">[docs]</a>    <span class="k">def</span> <span class="nf">actualize_set</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Makes additional processing of set parameters, which also depends on calculation</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="c1">#check if some parameters should be filled according to number of species</span>
        <span class="c1">#make element list</span>
        <span class="n">el_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">element_name_inv</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">znucl</span><span class="p">]</span>
        <span class="n">vp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span>


        <span class="k">if</span> <span class="s1">&#39;LDAU&#39;</span> <span class="ow">in</span> <span class="n">vp</span> <span class="ow">and</span> <span class="n">vp</span><span class="p">[</span><span class="s1">&#39;LDAU&#39;</span><span class="p">]:</span>        
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;LDAUL&#39;</span><span class="p">,</span> <span class="s1">&#39;LDAUU&#39;</span><span class="p">,</span> <span class="s1">&#39;LDAUJ&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">vp</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">el_list</span><span class="p">)):</span> <span class="c1">#no common elements at all</span>
                    <span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">Error! The &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; doesnt not contain values for your elements!</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span>

                <span class="n">new</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">el_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">vp</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">vp</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">el</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;LDAUL&#39;</span><span class="p">:</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">val</span> <span class="o">=</span>  <span class="mi">0</span>

                    <span class="n">new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="n">vp</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span></div>


<div class="viewcode-block" id="CalculationVasp.make_incar_and_copy_all"><a class="viewcode-back" href="../index.html#classes.CalculationVasp.make_incar_and_copy_all">[docs]</a>    <span class="k">def</span> <span class="nf">make_incar_and_copy_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes Incar file for current calculation and copy all</span>
<span class="sd">        TO DO: there is no need to send all POSCAR files; It is enothg to send only one. However for rsync its not that crucial</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#print &quot;Begin make---------------------------------------------&quot;</span>
        
        
        <span class="c1">#Generate incar</span>
        <span class="n">vp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span>
        <span class="n">natom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">natom</span>
        <span class="c1">#please make consistent</span>

        <span class="k">if</span> <span class="s1">&#39;MAGMOM&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s1">&#39;MAGMOM&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s2">&quot;*&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s1">&#39;MAGMOM&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s1">&#39;MAGMOM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">natom</span><span class="p">)</span> <span class="o">+</span><span class="s2">&quot;*&quot;</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s1">&#39;MAGMOM&#39;</span><span class="p">]</span>
        

        








        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="s2">&quot;INCAR&quot;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s1">&#39;SYSTEM = </span><span class="si">%s</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">des</span><span class="p">)</span> <span class="p">)</span>
            <span class="c1">#f.write( &#39;Other parameters for this Run:\n&#39; )</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1">#print type(self.set.vasp_params[key])</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="c1"># f.write(key+&quot; = &quot;+str(self.set.vasp_params[key][0])+&quot; &quot;+str(self.set.vasp_params[key][1])+&quot;\n&quot;)</span>
                    <span class="n">lis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;{:}&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">lis</span><span class="p">))</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">lis</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                


                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot; = &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
           






            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s1">&#39;ISPIN&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">magmom</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="c1">#write magnetic moments of atoms</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MAGMOM = &quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">magmom</span><span class="p">:</span>    
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>


            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1">#f.write( &#39;Electronic Relaxation 1:\n&#39; )</span>

            <span class="c1">#f.write(&quot;\n&quot;)</span>
            <span class="c1">#f.write( &#39;Ionic Relaxation:\n&#39; )</span>
       
            <span class="c1">#f.write(&quot;\n&quot;)</span>
        <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;INCAR was generated</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1">#Generate KPOINTS</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">kpoints_file</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">kpoints_file</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;You said to generate KPOINTS file.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calc_kspacings</span><span class="p">()</span>
                <span class="c1">#Generate kpoints file</span>

                <span class="c1">#</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">ngkpt</span><span class="p">:</span>
                    <span class="n">nk1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">ngkpt</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">nk2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">ngkpt</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">nk3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">ngkpt</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
                    <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;Attention! ngkpt was used for kpoints file</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;Attention! ngkpt for kpoints file are created from kspacing; ngkpt is empty</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_kpoints</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">ngkpt</span> <span class="o">=</span> <span class="n">N</span>
                    <span class="n">nk1</span> <span class="o">=</span> <span class="n">N</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">nk2</span> <span class="o">=</span> <span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">nk3</span> <span class="o">=</span> <span class="n">N</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="s2">&quot;KPOINTS&quot;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>

                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Automatic Mesh</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1">#Comment</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;0 </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="c1">#Number of points; 0-Auto</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s2">&quot;KGAMMA&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.TRUE.&quot;</span><span class="p">:</span> 
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Gamma</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> 
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Monkhorst Pack</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1"> </span><span class="si">%i</span><span class="s1"> </span><span class="si">%i</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">nk1</span><span class="p">,</span> <span class="n">nk2</span><span class="p">,</span> <span class="n">nk3</span><span class="p">)</span> <span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;0 0 0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># optional shift</span>

                <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;KPOINTS was generated</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">kpoints_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="s2">&quot;KPOINTS&quot;</span><span class="p">)</span>
                <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;KPOINTS was copied from&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">kpoints_file</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>



            <span class="n">list_to_copy</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">+</span><span class="s2">&quot;INCAR&quot;</span><span class="p">,</span><span class="n">d</span><span class="o">+</span><span class="s2">&quot;POTCAR&quot;</span><span class="p">,</span><span class="n">d</span><span class="o">+</span><span class="s2">&quot;KPOINTS&quot;</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">print_and_log</span><span class="p">(</span> <span class="s2">&quot;This set is without KPOINTS file.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">list_to_copy</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">+</span><span class="s2">&quot;INCAR&quot;</span><span class="p">,</span><span class="n">d</span><span class="o">+</span><span class="s2">&quot;POTCAR&quot;</span><span class="p">]</span>

            <span class="c1">#N = []</span>
            <span class="c1">#for i in 0, 1, 2:</span>
                <span class="c1">#N.append( math.ceil( (np.linalg.norm(self.recip[i]) / to_ang) / self.set.vasp_params[&#39;KSPACING&#39;]) )</span>
            <span class="c1">#print &quot;Vector length is:&quot;, (np.linalg.norm(self.rprimd[0]), &quot;Bohr&quot;</span>
            <span class="c1">#print_and_log(&quot;Kpoint   mesh is: &quot;+str(N) )</span>
            <span class="c1">#print_and_log(&quot;The actual k-spacings is &quot;+str(self.calc_kspacings(N) ) )</span>
        <span class="c1">#Copy section</span>


        <span class="n">list_to_copy</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">d</span><span class="o">+</span><span class="s1">&#39;/*POSCAR*&#39;</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">list_to_copy</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">d</span><span class="o">+</span><span class="s1">&#39;/*.run*&#39;</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">string_of_paths</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">for</span> <span class="n">nf</span> <span class="ow">in</span> <span class="n">list_to_copy</span><span class="p">:</span>
            <span class="n">string_of_paths</span> <span class="o">+=</span> <span class="n">nf</span><span class="o">+</span><span class="s2">&quot; &quot;</span> <span class="c1">#Compose all files for copy in one string</span>

        
        <span class="k">if</span> <span class="s2">&quot;up&quot;</span> <span class="ow">in</span> <span class="n">update</span><span class="p">:</span> <span class="c1">#Copy to server</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Files to copy: &quot;</span><span class="o">+</span><span class="n">string_of_paths</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># temp_dir = os.path.dirname(project_path_cluster+self.dir)</span>
            <span class="n">runBash</span><span class="p">(</span><span class="s1">&#39;ssh &#39;</span><span class="o">+</span> <span class="n">cluster_address</span><span class="o">+</span><span class="s1">&#39; &quot;mkdir -p &#39;</span><span class="o">+</span><span class="n">project_path_cluster</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="c1">#create directory</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">runBash</span><span class="p">(</span><span class="s2">&quot;rsync -zave ssh &quot;</span><span class="o">+</span><span class="n">string_of_paths</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="n">cluster_address</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="n">project_path_cluster</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="p">)</span></div>
        <span class="c1">#print &quot;End make---------------------------------------------\n\n&quot;</span>



<div class="viewcode-block" id="CalculationVasp.write_sge_script"><a class="viewcode-back" href="../index.html#classes.CalculationVasp.write_sge_script">[docs]</a>    <span class="k">def</span> <span class="nf">write_sge_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_geofile</span> <span class="o">=</span> <span class="s2">&quot;header&quot;</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">option</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">prevcalcver</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">savefile</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">schedule_system</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Without arguments writes header, else adds sequence of calculatios</span>
<span class="sd">            option - &#39;inherit_xred&#39; - control inheritance, or &#39;master&#39; - run serial on master </span>
<span class="sd">            prevcalcver - ver of previous calc; for first none</span>
<span class="sd">            savefile - &#39;cdawx&#39;, where c-charge, d-dos, a- AECCAR, w-wavefile, x-xml</span>
<span class="sd">            schedule_system - type of job scheduling system:&#39;PBS&#39;, &#39;SGE&#39;, &#39;SLURM&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>

        
        <span class="k">if</span> <span class="n">schedule_system</span> <span class="o">==</span> <span class="s1">&#39;SGE&#39;</span><span class="p">:</span>
            <span class="n">parrallel_run_command</span> <span class="o">=</span> <span class="s2">&quot;mpirun -x PATH vasp&quot;</span>
        <span class="k">elif</span> <span class="n">schedule_system</span> <span class="o">==</span> <span class="s1">&#39;PBS&#39;</span><span class="p">:</span>
            <span class="n">parrallel_run_command</span> <span class="o">=</span> <span class="s2">&quot;mpiexec --prefix /home/aleksenov_d/mpi/openmpi-1.6.3/installed vasp&quot;</span>
        
        <span class="k">elif</span> <span class="n">schedule_system</span> <span class="o">==</span> <span class="s1">&#39;SLURM&#39;</span><span class="p">:</span>
            <span class="n">parrallel_run_command</span> <span class="o">=</span> <span class="s2">&quot;prun /opt/vasp/bin/vasp5.4.1MPI&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span>


        <span class="n">run_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.run&#39;</span>        
        <span class="n">job_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">input_geofile</span> <span class="o">==</span> <span class="s2">&quot;header&quot;</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_name</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">schedule_system</span> <span class="o">==</span> <span class="s1">&#39;SGE&#39;</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#!/bin/tcsh   </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#$ -M aksenov@mpie.de</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#$ -m be</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#$ -S /bin/tcsh</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#$ -cwd </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#$ -R y </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#$ -o &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="s2">&quot; -j y</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;cd &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;module load sge</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;module load vasp/parallel/5.2.12</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>


                <span class="c1"># import random</span>
                <span class="c1"># foo = [&#39;01&#39;, &#39;02&#39;, &#39;03&#39;, &#39;04&#39;, &#39;05&#39;, &#39;06&#39;, &#39;07&#39;, &#39;08&#39;, &#39;10&#39;, &#39;12&#39;, &#39;13&#39;, &#39;15&#39;, &#39;16&#39;, &#39;17&#39;, &#39;18&#39;, &#39;19&#39;, &#39;20&#39;]</span>
                <span class="c1"># print(random.choice(foo)</span>

                <span class="k">if</span> <span class="n">schedule_system</span> <span class="o">==</span> <span class="s1">&#39;PBS&#39;</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#!/bin/bash   </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#PBS -N &quot;</span><span class="o">+</span><span class="n">job_name</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#PBS -l walltime=99999999:00:00 </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#PBS -l nodes=1:ppn=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">corenum</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#PBS -r n</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#PBS -j eo</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#PBS -m bea</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#PBS -M dimonaks@gmail.com</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;cd $PBS_O_WORKDIR</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;PATH=/share/apps/vasp/bin:/home/aleksenov_d/mpi/openmpi-1.6.3/installed/bin:/usr/bin:$PATH </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;LD_LIBRARY_PATH=/home/aleksenov_d/lib64:$LD_LIBRARY_PATH </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># f.write(&quot;cd &quot;+self.dir+&quot;\n&quot;)</span>

                    <span class="c1"># f.write(&quot;module load sge\n&quot;)</span>
                    <span class="c1"># f.write(&quot;module load vasp/parallel/5.2.12\n\n&quot;)</span>

                <span class="k">if</span> <span class="n">schedule_system</span> <span class="o">==</span> <span class="s1">&#39;SLURM&#39;</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#!/bin/bash   </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH -J &quot;</span><span class="o">+</span><span class="n">job_name</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH -t 250:00:00 </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH -N 1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH -n &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">corenum</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH -o &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="s2">&quot;sbatch.out</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH -e &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="s2">&quot;sbatch.err</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH --mem-per-cpu=7675</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH --mail-user=d.aksenov@skoltech.ru</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#SBATCH --mail-type=END</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;cd &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;export OMP_NUM_THREADS=1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;module add prun/1.0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;module add intel/16.0.2.181</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;module add impi/5.1.3.181</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>




                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;rm WAVECAR</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>                
                <span class="c1"># f.write(&quot;rm WAVECAR\n&quot;)                </span>

            <span class="c1"># f.close()</span>




        <span class="k">else</span><span class="p">:</span> <span class="c1">#control part of script</span>

            <span class="n">v</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
            
            <span class="k">def</span> <span class="nf">prepare_input</span><span class="p">(</span><span class="n">prevcalcver</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">option</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">input_geofile</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">name_mod</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;1. Input files preparation&quot;&quot;&quot;</span>  

                <span class="n">precont</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">prevcalcver</span><span class="p">)</span><span class="o">+</span><span class="n">name_mod</span><span class="o">+</span><span class="s1">&#39;.CONTCAR&#39;</span>
                <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;inherit_xred&#39;</span> <span class="ow">and</span> <span class="n">prevcalcver</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;grep -A &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">natom</span><span class="p">)</span><span class="o">+</span> <span class="s1">&#39; &quot;Direct&quot; &#39;</span><span class="o">+</span><span class="n">precont</span><span class="o">+</span><span class="s1">&#39; &gt;&gt; &#39;</span><span class="o">+</span><span class="n">input_geofile</span><span class="o">+</span> <span class="s1">&#39; </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;cp &quot;</span><span class="o">+</span><span class="n">input_geofile</span><span class="o">+</span><span class="s2">&quot; POSCAR</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">def</span> <span class="nf">update_incar</span><span class="p">(</span><span class="n">parameter</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>    
                <span class="sd">&quot;&quot;&quot;1.5 Update INCAR&quot;&quot;&quot;</span>


                <span class="k">if</span> <span class="n">parameter</span> <span class="o">==</span> <span class="s1">&#39;LDAUU&#39;</span><span class="p">:</span>
                    <span class="c1">#Update only non-zero elements of LDAUU with value</span>

                    <span class="n">set_LDAUU_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s1">&#39;LDAUU&#39;</span><span class="p">]</span>
                    <span class="n">new_LDAUU_list</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">set_LDAUU_list</span><span class="p">)</span>
                    
                    <span class="c1"># print set_LDAUU_list</span>

                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">set_LDAUU_list</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">u</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
                        <span class="n">new_LDAUU_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>


                    <span class="n">new_LDAUU</span> <span class="o">=</span> <span class="s1">&#39;LDAUU = &#39;</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;{:}&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">new_LDAUU_list</span><span class="p">))</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">new_LDAUU_list</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;sed -i.bak &#39;/LDAUU/c</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">new_LDAUU</span> <span class="o">+</span> <span class="s2">&quot;&#39; INCAR</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>






                <span class="k">return</span>

            <span class="k">def</span> <span class="nf">run_command</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">parrallel_run_command</span><span class="p">,):</span>
                <span class="sd">&quot;&quot;&quot;2. Running&quot;&quot;&quot;</span> 

                <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;master&#39;</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;vasp &gt;&quot;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;.log</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">parrallel_run_command</span> <span class="o">+</span><span class="s2">&quot; &gt;&quot;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;.log</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;sleep 20</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>


            <span class="k">def</span> <span class="nf">mv_files_according_versions</span><span class="p">(</span><span class="n">savefile</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">name_mod</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>    
                <span class="sd">&quot;&quot;&quot;3. Out files saving block&quot;&quot;&quot;</span>   
                <span class="k">if</span> <span class="s2">&quot;o&quot;</span> <span class="ow">in</span> <span class="n">savefile</span><span class="p">:</span>

                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;mv OUTCAR &quot;</span>          <span class="o">+</span> <span class="n">v</span> <span class="o">+</span> <span class="n">name_mod</span> <span class="o">+</span>  <span class="s2">&quot;.OUTCAR</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;mv CONTCAR &quot;</span>         <span class="o">+</span> <span class="n">v</span> <span class="o">+</span> <span class="n">name_mod</span> <span class="o">+</span>  <span class="s2">&quot;.CONTCAR</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="s2">&quot;c&quot;</span> <span class="ow">in</span> <span class="n">savefile</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;mv CHG &quot;</span>         <span class="o">+</span> <span class="n">v</span> <span class="o">+</span> <span class="n">name_mod</span> <span class="o">+</span> <span class="s2">&quot;.CHG</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;mv CHGCAR &quot;</span>      <span class="o">+</span> <span class="n">v</span> <span class="o">+</span> <span class="n">name_mod</span> <span class="o">+</span> <span class="s2">&quot;.CHGCAR</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="s2">&quot;d&quot;</span> <span class="ow">in</span> <span class="n">savefile</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;mv DOSCAR &quot;</span>      <span class="o">+</span> <span class="n">v</span> <span class="o">+</span> <span class="n">name_mod</span> <span class="o">+</span> <span class="s2">&quot;.DOSCAR</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="s2">&quot;a&quot;</span> <span class="ow">in</span> <span class="n">savefile</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;mv AECCAR0 &quot;</span>     <span class="o">+</span> <span class="n">v</span> <span class="o">+</span> <span class="n">name_mod</span> <span class="o">+</span> <span class="s2">&quot;.AECCAR0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;mv AECCAR2 &quot;</span>     <span class="o">+</span> <span class="n">v</span> <span class="o">+</span> <span class="n">name_mod</span> <span class="o">+</span> <span class="s2">&quot;.AECCAR2</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">savefile</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;mv vasprun.xml &quot;</span> <span class="o">+</span> <span class="n">v</span> <span class="o">+</span> <span class="n">name_mod</span> <span class="o">+</span> <span class="s2">&quot;.vasprun.xml</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
               
                <span class="k">if</span> <span class="s1">&#39;w&#39;</span> <span class="ow">in</span> <span class="n">savefile</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;mv WAVECAR &quot;</span>     <span class="o">+</span> <span class="n">v</span> <span class="o">+</span> <span class="n">name_mod</span> <span class="o">+</span> <span class="s2">&quot;.WAVECAR</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">return</span>


            <span class="k">def</span> <span class="nf">analysis_script</span><span class="p">():</span>
                <span class="c1">#now only for u-ramping</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;touch ENERGIES</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>                

                <span class="k">for</span> <span class="n">outcar</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">accosiated_outcars</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;grep &#39;free  energy&#39; &quot;</span><span class="o">+</span><span class="n">outcar</span><span class="o">+</span><span class="s2">&quot; | awk &#39;{print $5}&#39; &gt;&gt; ENERGIES</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>





            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_name</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="c1">#append information about run</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_method</span> <span class="o">==</span> <span class="s1">&#39;u_ramping&#39;</span><span class="p">:</span>
                    <span class="n">U_last</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">u_ramping_region</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">name_mod_2</span> <span class="o">=</span> <span class="s1">&#39;.U&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">U_last</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>


                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;rm CHGCAR</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>                

                    <span class="bp">self</span><span class="o">.</span><span class="n">accosiated_outcars</span> <span class="o">=</span> <span class="p">[]</span>


                    <span class="k">for</span> <span class="n">U</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">u_ramping_region</span><span class="p">):</span>

                        <span class="n">name_mod</span>   <span class="o">=</span> <span class="s1">&#39;.U&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">U</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>

                        <span class="n">update_incar</span><span class="p">(</span><span class="n">parameter</span> <span class="o">=</span> <span class="s1">&#39;LDAUU&#39;</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">U</span><span class="p">)</span>

                        <span class="n">prepare_input</span><span class="p">(</span><span class="n">prevcalcver</span> <span class="o">=</span> <span class="n">prevcalcver</span><span class="p">,</span> <span class="n">option</span> <span class="o">=</span> <span class="n">option</span><span class="p">,</span> <span class="n">input_geofile</span> <span class="o">=</span> <span class="n">input_geofile</span><span class="p">,</span> <span class="n">name_mod</span> <span class="o">=</span> <span class="n">name_mod_2</span><span class="p">)</span>
                        
                        <span class="n">run_command</span><span class="p">(</span><span class="n">option</span> <span class="o">=</span> <span class="n">option</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="n">name_mod</span><span class="p">,</span> <span class="n">parrallel_run_command</span> <span class="o">=</span> <span class="n">parrallel_run_command</span><span class="p">)</span>

                        <span class="n">mv_files_according_versions</span><span class="p">(</span><span class="n">savefile</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">name_mod</span> <span class="o">=</span> <span class="n">name_mod</span><span class="p">)</span>
                    
                        <span class="bp">self</span><span class="o">.</span><span class="n">accosiated_outcars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">v</span> <span class="o">+</span> <span class="n">name_mod</span> <span class="o">+</span>  <span class="s2">&quot;.OUTCAR&quot;</span>  <span class="p">)</span>

                    <span class="n">mv_files_according_versions</span><span class="p">(</span><span class="n">savefile</span> <span class="o">=</span> <span class="s1">&#39;cd&#39;</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">name_mod</span> <span class="o">=</span> <span class="n">name_mod</span><span class="p">)</span> <span class="c1">#save more files for last U</span>
                    <span class="n">analysis_script</span><span class="p">()</span>
                    <span class="c1"># print self.accosiated_outcars</span>




                <span class="k">else</span><span class="p">:</span>
                    
                    <span class="n">prepare_input</span><span class="p">(</span><span class="n">prevcalcver</span> <span class="o">=</span> <span class="n">prevcalcver</span><span class="p">,</span> <span class="n">option</span> <span class="o">=</span> <span class="n">option</span><span class="p">,</span> <span class="n">input_geofile</span> <span class="o">=</span> <span class="n">input_geofile</span><span class="p">)</span>

                    <span class="n">run_command</span><span class="p">(</span><span class="n">option</span> <span class="o">=</span> <span class="n">option</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">parrallel_run_command</span> <span class="o">=</span> <span class="n">parrallel_run_command</span><span class="p">)</span>

                    <span class="n">mv_files_according_versions</span><span class="p">(</span><span class="n">savefile</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>




                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;rm WAVECAR</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">runBash</span><span class="p">(</span><span class="s1">&#39;chmod +x &#39;</span><span class="o">+</span><span class="n">run_name</span><span class="p">)</span>

            <span class="k">return</span></div>
    



<div class="viewcode-block" id="CalculationVasp.make_run"><a class="viewcode-back" href="../index.html#classes.CalculationVasp.make_run">[docs]</a>    <span class="k">def</span> <span class="nf">make_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schedule_system</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate run file</span>

<span class="sd">        INPUT:</span>
<span class="sd">            schedule_system - </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">run_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.run&#39;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">schedule_system</span> <span class="o">==</span> <span class="s1">&#39;SGE&#39;</span><span class="p">:</span>
                <span class="c1">#&#39;qsub -pe &#39;mpi*&#39; NCORES -l CLUSTER_TAG script.parallel.sh&#39; for mpi-jobs which should run on CLUSTER_TAG (cmmd or cmdft)</span>
                <span class="c1">#IMPORTANT: NCORES must be a multiple of 8(24) on cmdft(cmmd). </span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;qsub -pe &#39;mpi*&#39; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">corenum</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="n">header</span><span class="o">.</span><span class="n">queue</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="n">run_name</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1">#str(self.set.np) #-l cmmd</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;sleep 5</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="c1"># runBash(&#39;chmod +x run&#39;)</span>
            <span class="k">if</span> <span class="n">schedule_system</span> <span class="o">==</span> <span class="s1">&#39;PBS&#39;</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;cd &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;qsub &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.run&#39;</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> 
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;cd -</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;sleep 5</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>                        
            
            <span class="k">if</span> <span class="n">schedule_system</span> <span class="o">==</span> <span class="s1">&#39;SLURM&#39;</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;sbatch -p AMG &quot;</span> <span class="o">+</span> <span class="n">run_name</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> 

                



        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;3. Ready for start&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Run file created</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>     
        <span class="k">return</span></div>



<div class="viewcode-block" id="CalculationVasp.calc_kspacings"><a class="viewcode-back" href="../index.html#classes.CalculationVasp.calc_kspacings">[docs]</a>    <span class="k">def</span> <span class="nf">calc_kspacings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ngkpt</span> <span class="o">=</span> <span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;Calculates reciprocal vectors and kspacing from ngkpt&quot;&quot;&quot;</span>
        <span class="n">to_ang_local</span> <span class="o">=</span> <span class="n">to_ang</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;Ang&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">len_units</span><span class="p">:</span>
                <span class="n">to_ang_local</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="c1">#print &quot;units angs&quot;</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Warning! no len_units for &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot; calculation, I use Bohr </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1">#Determine reciprocal vectors</span>
        <span class="k">if</span> <span class="mi">1</span><span class="p">:</span> <span class="c1">#Already calculated during reading of structure</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recip</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  <span class="p">);</span> <span class="c1">#volume</span>
            <span class="c1">#print vol</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recip</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>   <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span>   <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recip</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>   <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>   <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recip</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>   <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>   <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">recip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">recip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">vol</span><span class="p">;</span>
        <span class="c1">#print self.recip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kspacing</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ngkpt</span><span class="p">:</span>
            <span class="n">ngkpt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">ngkpt</span>
        <span class="n">k</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ngkpt</span><span class="p">:</span>
            <span class="c1"># print &#39;ngkpt are &#39;, ngkpt</span>
            <span class="c1"># print &#39;recip are&#39;, self.recip</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">recip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span> <span class="o">/</span> <span class="n">ngkpt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">to_ang_local</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kspacing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">red_prec</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
            <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kspacing</span>
        <span class="c1">#print &quot;Spacings for %s is [%.2f, %.2f, %.2f]&quot;%(self.set.ngkpt,k[0], k[1], k[2])</span>
        <span class="k">return</span>  <span class="n">k</span></div>

    <span class="k">def</span> <span class="nf">read_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">load</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">out_type</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">voronoi</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">):</span>

        <span class="c1">#Start to read OUTCAR</span>
        <span class="c1"># print self.version, &#39;version&#39;</span>
        <span class="n">path_to_outcar</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span>
        <span class="n">path_to_contcar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.CONTCAR&quot;</span>
        <span class="n">path_to_xml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.vasprun.xml&quot;</span>



        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_method</span> <span class="o">==</span> <span class="s1">&#39;u_ramping&#39;</span><span class="p">:</span>
            <span class="n">lor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accosiated_outcars</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">path_to_outcar</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="n">lor</span>
            <span class="n">path_to_contcar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="n">lor</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;OUT&#39;</span><span class="p">,</span> <span class="s1">&#39;CONT&#39;</span><span class="p">)</span>
            <span class="n">path_to_xml</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="n">lor</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;OUTCAR&#39;</span><span class="p">,</span> <span class="s1">&#39;vasprun.xml&#39;</span><span class="p">)</span>         
            <span class="c1"># print &#39;sdf&#39;, path_to_outcar, path_to_contcar, path_to_xml</span>
            <span class="n">energies_str</span> <span class="o">=</span> <span class="n">runBash</span><span class="p">(</span><span class="s2">&quot;ssh &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_address</span><span class="o">+</span><span class="s2">&quot; cat &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="s2">&quot;ENERGIES&quot;</span><span class="p">)</span>
            <span class="c1"># print &quot;ssh &quot;+self.cluster_address+&quot; cat &quot;+self.dir+&quot;ENERGIES&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">u_ramping_energies</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">energies_str</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">u_ramping_u_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">u_ramping_region</span><span class="p">)</span>
            <span class="c1"># print &#39;energies&#39;, energies</span>





        <span class="n">contcar_exist</span>   <span class="o">=</span> <span class="bp">False</span>
 
        <span class="bp">self</span><span class="o">.</span><span class="n">natom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">natom</span>

        <span class="sd">&quot;&quot;&quot;Copy from server &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">load</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

            <span class="c1">#reduce size of downloadable file: vasp 4 and 5</span>
            <span class="n">command_reduce</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;ssh {0:s} nbands=\`grep </span><span class="se">\\</span><span class="s2">&quot;NBANDS=</span><span class="se">\\</span><span class="s2">&quot; \{1:s} \| awk </span><span class="se">\\</span><span class="s2">&#39;{{print \$NF - 1}}</span><span class="se">\\</span><span class="s2">&#39;\`\; sed -i -e </span><span class="se">\\</span><span class="s2">&quot;/band No./,+\${{nbands}}d</span><span class="se">\\</span><span class="s2">&quot; \{1:s} &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cluster_address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path_cluster</span><span class="o">+</span><span class="n">path_to_outcar</span> <span class="p">)</span>
            <span class="c1"># print command_reduce</span>

            <span class="n">runBash</span><span class="p">(</span><span class="n">command_reduce</span><span class="p">)</span>

            <span class="c1"># print &quot;rsync -zave ssh &quot;+cluster_address+&quot;:&quot;+project_path_cluster+path_to_outcar+&quot; &quot;+self.dir</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">runBash</span><span class="p">(</span><span class="s2">&quot;rsync -zave ssh &quot;</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_address</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path_cluster</span><span class="o">+</span><span class="n">path_to_outcar</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="p">)</span> <span class="c1">#OUTCAR</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">runBash</span><span class="p">(</span><span class="s2">&quot;rsync -zave ssh &quot;</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_address</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path_cluster</span><span class="o">+</span><span class="n">path_to_contcar</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="p">)</span> <span class="c1">#CONTCAR</span>
            <span class="c1"># log.write( runBash(&quot;rsync -zave ssh &quot;+cluster_address+&quot;:&quot;+project_path_cluster+path_to_xml+&quot; &quot;+self.dir)+&#39;\n&#39; ) #CONTCAR</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_outcar</span><span class="p">):</span> 
                <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">No OUTCAR file even on server; Continue... </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="sd">&quot;&quot;&quot;Calculate voronoi volume&quot;&quot;&quot;</span>
                <span class="c1"># print hasattr(self, &#39;vorovol&#39;)</span>
                <span class="k">if</span> <span class="n">voronoi</span><span class="p">:</span><span class="c1"># and not hasattr(self, &#39;vorovol&#39;):#out_type == &#39;e_seg&#39;:</span>
                    <span class="n">calculate_voronoi</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">return</span>
                <span class="c1"># raise RuntimeError</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_outcar</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">path_to_outcar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="s2">&quot;OUTCAR&quot;</span> <span class="c1"># For compability only for version 1</span>
            <span class="k">if</span> <span class="n">load</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">runBash</span><span class="p">(</span><span class="s2">&quot;rsync -zave ssh &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_address</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path_cluster</span><span class="o">+</span><span class="n">path_to_outcar</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Warning! I have used OUTCAR instead of 1.OUTCAR</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_outcar</span><span class="p">):</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">No OUTCAR file... </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_contcar</span><span class="p">):</span>
            <span class="n">contcar_exist</span>   <span class="o">=</span> <span class="bp">True</span>





        <span class="sd">&quot;&quot;&quot;Start reading &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">runBash</span><span class="p">(</span><span class="s2">&quot;grep &#39;General timing&#39; &quot;</span><span class="o">+</span><span class="n">path_to_outcar</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;g&quot;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="c1">#print s</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;4. Calculation completed.&quot;</span>
        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;3. Partly completed!.&quot;</span>
        <span class="c1"># print self.state</span>
        <span class="k">if</span> <span class="s2">&quot;4&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">:</span>

            <span class="c1">#war = runBash(&#39;grep &quot;NPAR = approx SQRT( number of cores)&quot; &#39;+path_to_outcar) #remove warinig</span>
            <span class="n">nw</span> <span class="o">=</span> <span class="n">runBash</span><span class="p">(</span><span class="s1">&#39;sed -n &quot;/NPAR = approx SQRT( number of cores)/=&quot; &#39;</span><span class="o">+</span><span class="n">path_to_outcar</span><span class="p">)</span> <span class="c1">#remove warinig</span>
                    <span class="c1"># print runBash(&quot;sed &#39;/from  /, /to  /d&#39; &quot;+path_to_outcar)</span>
                    <span class="c1">#print &quot;sed -e &#39;15,34d&#39; &quot;+path_to_outcar</span>
            <span class="c1">#print &#39;grep &quot;NPAR = approx SQRT( number of cores)&quot; &#39;+path_to_outcar</span>
            <span class="c1">#print nw</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">path_to_outcar</span><span class="o">+</span><span class="s2">&quot;.tmp&quot;</span>
            <span class="k">if</span> <span class="n">nw</span><span class="p">:</span>
                <span class="n">nw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nw</span><span class="p">)</span>
                <span class="c1">#print &quot;sed &#39;&quot;+str(nw-11)+&quot;,&quot;+str(nw+8)+&quot;d&#39; &quot;+path_to_outcar+&quot;&gt;&quot;+tmp+&quot;;mv &quot;+tmp+&quot; &quot;+path_to_outcar</span>
                <span class="n">runBash</span><span class="p">(</span><span class="s2">&quot;sed &#39;&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nw</span><span class="o">-</span><span class="mi">11</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;,&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nw</span><span class="o">+</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;d&#39; &quot;</span><span class="o">+</span><span class="n">path_to_outcar</span><span class="o">+</span><span class="s2">&quot;&gt;&quot;</span><span class="o">+</span><span class="n">tmp</span><span class="o">+</span><span class="s2">&quot;;mv &quot;</span><span class="o">+</span><span class="n">tmp</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="n">path_to_outcar</span><span class="p">)</span>
                <span class="k">pass</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_outcar</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outcar</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Start reading from &quot;</span><span class="o">+</span> <span class="n">path_to_outcar</span><span class="o">+</span><span class="s2">&quot; </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">outcarlines</span> <span class="o">=</span> <span class="n">outcar</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

            <span class="n">re_lengths</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;length of vectors&quot;</span><span class="p">)</span>
            <span class="n">re_eltime</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;Elapsed time&quot;</span><span class="p">)</span>
            <span class="n">re_nkpts</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;NKPTS&quot;</span><span class="p">)</span>

            <span class="n">i_line</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">iterat</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mdstep</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">warnings</span> <span class="o">=</span> <span class="mi">0</span><span class="c1">#&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">nscflist</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">;</span> <span class="n">mdstep_old</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">niter_old</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">maxforce</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">average</span> <span class="o">=</span> <span class="p">[];</span>  <span class="n">gstress</span> <span class="o">=</span><span class="p">[]</span>
            <span class="c1"># mforce = []</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_e_sigma0</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_e_without_entr</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">)</span> <span class="c1"># below needed end values will be updated</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">Structure</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="s2">&quot;natom&quot;</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">natom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span>
            <span class="c1">#Structure() #create structure object with end values after calculation</span>
            <span class="c1">#self.end.typat = self.typat</span>
            <span class="c1">#self.end.znucl = self.znucl</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;.end&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">list_xcart</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="n">empty_struct</span><span class="p">()</span>

            <span class="n">nsgroup</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">magnitudes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># print self.set.vasp_params</span>

            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">outcarlines</span><span class="p">:</span>

                <span class="c1">#Check bands</span>

                <span class="c1"># if &#39;band No.&#39; in line:</span>
                <span class="c1">#     kpoint = float(outcarlines[i_line-1].split()[1])</span>
                <span class="c1">#     lastocc = float(outcarlines[i_line+self.nbands].split()[2])</span>
                <span class="c1">#     lastbandno = outcarlines[i_line+self.nbands].split()[0]</span>
                <span class="c1">#     if lastocc &gt; 0:</span>
                <span class="c1">#         print &quot;Warning!!! at kpoint &quot;, kpoint, &quot; last band No. &quot;,lastbandno, &quot; is not empty &quot;, lastocc</span>




                <span class="k">if</span> <span class="s2">&quot;TOO FEW BANDS&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Warning! TOO FEW BANDS!!!</span><span class="se">\n\n\n</span><span class="s2">Warning! TOO FEW BANDS!!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>



                <span class="c1">#Check W(q)</span>
                <span class="k">if</span> <span class="s1">&#39;operators is LMAX&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">lmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">7</span><span class="p">])</span>
                    <span class="c1"># print &#39;lmax&#39;, lmax</span>
                <span class="k">if</span> <span class="s2">&quot;W(low)/X(q)&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">kk</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">low</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">high</span> <span class="o">=</span> <span class="p">[];</span>
                    <span class="k">while</span> <span class="n">kk</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;Optimization&#39;</span> <span class="ow">in</span> <span class="n">outcarlines</span><span class="p">[</span><span class="n">i_line</span> <span class="o">+</span> <span class="n">kk</span><span class="p">]</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">outcarlines</span><span class="p">[</span><span class="n">i_line</span> <span class="o">+</span> <span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">:</span> <span class="k">break</span>
                        <span class="c1"># print &#39;line&#39;, outcarlines[i_line + kk]</span>

                        <span class="n">low</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>  <span class="nb">float</span><span class="p">(</span><span class="n">outcarlines</span><span class="p">[</span><span class="n">i_line</span> <span class="o">+</span> <span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">])</span> <span class="p">)</span>
                        <span class="n">high</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="n">outcarlines</span><span class="p">[</span><span class="n">i_line</span> <span class="o">+</span> <span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">5</span><span class="p">])</span> <span class="p">)</span>
                        <span class="n">kk</span><span class="o">+=</span><span class="mi">1</span>


                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="mf">1e-3</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">low</span><span class="o">+</span><span class="n">high</span><span class="p">):</span>
                        <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;W(q)/X(q) are too high, check output!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">print</span> <span class="s1">&#39;Low + high = &#39;</span><span class="p">,</span> <span class="n">low</span><span class="o">+</span><span class="n">high</span>
                        <span class="k">print</span> <span class="p">[</span><span class="n">v</span> <span class="o">&gt;</span> <span class="mf">1e-3</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">low</span><span class="o">+</span><span class="n">high</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;direct lattice vectors&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">ri</span><span class="p">)</span> <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="n">outcarlines</span><span class="p">[</span><span class="n">i_line</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>   <span class="p">]</span> <span class="p">)</span>
                    <span class="c1">#print self.end.rprimd</span>
                    <span class="c1">#print self.rprimd</span>
                <span class="k">if</span> <span class="s2">&quot;POSITION&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">contcar_exist</span> <span class="ow">or</span> <span class="n">out_type</span> <span class="o">==</span> <span class="s1">&#39;dimer&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">xcart</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#clean xcart before filling</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">natom</span><span class="p">):</span>
                            <span class="c1">#print outcarlines[i_line+1+i].split()[0:3] </span>
                            <span class="n">xcart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span> <span class="p">(</span> 
                                        <span class="p">[</span>   <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">outcarlines</span><span class="p">[</span><span class="n">i_line</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>   <span class="p">]</span> 
                                    <span class="p">)</span>
                            
                            <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">xcart</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">xcart</span> <span class="p">)</span>
                            <span class="c1">#self.end.xred.append ( xcart2xred( xcart, self.end.rprimd) )</span>
                
                        <span class="k">if</span> <span class="n">out_type</span> <span class="o">==</span> <span class="s1">&#39;dimer&#39;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">list_xcart</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">xcart</span><span class="p">)</span> <span class="c1">#xcart at each step only for dimer</span>

                        <span class="c1">#the change of typat is accounted below</span>

                <span class="k">if</span> <span class="s2">&quot;number of electron &quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="c1"># print line</span>
                    <span class="c1"># print line.split()[-1]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">magn1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">magn1</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="s2">&quot;augmentation part &quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">magn2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">magn2</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="s2">&quot;TOTAL-FORCE&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="c1"># Calculate forces here...</span>
                    <span class="n">forces</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">magnitudes</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">natom</span><span class="p">):</span>
                        <span class="n">parts</span> <span class="o">=</span> <span class="n">outcarlines</span><span class="p">[</span><span class="n">i_line</span><span class="o">+</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="c1"># print &quot;parts&quot;, parts</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                        <span class="n">z</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                        <span class="n">forces</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">])</span>
                        <span class="n">magnitudes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span> <span class="n">z</span><span class="o">*</span><span class="n">z</span><span class="p">))</span>
                    <span class="n">average</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">red_prec</span><span class="p">(</span> <span class="nb">sum</span><span class="p">(</span><span class="n">magnitudes</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">natom</span> <span class="o">*</span> <span class="mi">1000</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">imax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">magnitudes</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
                    <span class="n">maxforce</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span><span class="n">imax</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">magnitudes</span><span class="p">[</span><span class="n">imax</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)]</span>  <span class="p">)</span>
                    <span class="c1"># mforce.append( round(magnitudes[imax] * 1000))</span>
                    
                <span class="c1">#Check total drift</span>
                <span class="k">if</span> <span class="s2">&quot;total drift:&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="c1">#print line</span>
                    <span class="n">tdrift</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">]]</span>
                    <span class="c1">#if any(d &gt; 0.001 and d &gt; max(magnitudes) for d in tdrift):</span>
                        <span class="c1">#print_and_log(&quot;Total drift is too high = &quot;+str(tdrift)+&quot;, check output!\n&quot;)</span>
                        <span class="c1">#pass</span>


                <span class="k">if</span> <span class="s2">&quot;g(Stress)&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="c1">#print line</span>
                    <span class="n">gstress</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">round</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">])</span><span class="o">*</span><span class="mi">1000</span> <span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">3</span> <span class="p">)</span>  <span class="p">)</span>
                <span class="c1">#if &quot;Total&quot; in line:</span>
                    <span class="c1">#gstress.append( red_prec(float(line.split()[4])*1000 *100, 1000 )  )</span>
                <span class="k">if</span> <span class="s2">&quot;volume of cell&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>                     <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">vol</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Warning! Cant read volume in calc &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="c1">#print self.vol      </span>

                <span class="k">if</span> <span class="s2">&quot;generate k-points for:&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">ngkpt</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>  <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">:]]</span>  <span class="p">)</span>
                    <span class="c1">#print self.set.ngkpt</span>

                  <span class="c1"># Kohn-Sham hamiltonian: http://en.wikipedia.org/wiki/Kohn%E2%80%93Sham_equations</span>
                  <span class="c1">#kinetic energy</span>
                  <span class="c1">#+ the external potential + the exchange-correlation energy +</span>
                  <span class="c1">#+ Hartree (or Coulomb) energy</span>
                <span class="k">if</span>  <span class="s2">&quot;alpha Z        PSCENC&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># the electrostatic interaction of the ions in a compensating electron gas.</span>

                <span class="k">if</span>  <span class="s2">&quot;Ewald energy   TEWEN&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">ewald</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># the electrostatic interaction of the ions in a compensating electron gas.</span>
                    <span class="c1"># print self.energy.ewald</span>
                <span class="k">if</span>  <span class="s2">&quot;-1/2 Hartree   DENC&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">hartree</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#Coulomb electron-electron energy</span>
                    <span class="c1"># print self.energy.hartree</span>
                <span class="k">if</span>  <span class="s2">&quot;-V(xc)+E(xc)   XCENC&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">xc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Kohn-Sham exchange-correlation energy</span>
                <span class="k">if</span>  <span class="s2">&quot;PAW double counting&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">pawdc1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="c1">#</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">pawdc2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#</span>
                <span class="k">if</span>  <span class="s2">&quot;eigenvalues    EBANDS&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">bands</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># - Kohn Sham eigenvalues - include kinetic energy , but not exactly</span>
                <span class="k">if</span>  <span class="s2">&quot;atomic energy  EATOM&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">atomic</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#energy of atoms in the box</span>



                <span class="k">if</span> <span class="s2">&quot;energy  without entropy=&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="c1">#self.energy = float(line.split()[4])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">e_without_entr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span> <span class="c1">#</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">energy_sigma0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">6</span><span class="p">])</span> <span class="c1">#energy(sigma-&gt;0)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">list_e_sigma0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>  <span class="bp">self</span><span class="o">.</span><span class="n">energy_sigma0</span>  <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">list_e_without_entr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>  <span class="bp">self</span><span class="o">.</span><span class="n">e_without_entr</span>  <span class="p">)</span>




                <span class="k">if</span> <span class="s2">&quot;free  energy   TOTEN  =&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="c1">#self.energy = float(line.split()[4])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">energy_free</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">])</span> <span class="c1">#F free energy</span>
                <span class="k">if</span> <span class="n">re_lengths</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vlength</span> <span class="o">=</span> <span class="p">[</span><span class="n">red_prec</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="mi">1000</span> <span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">outcarlines</span><span class="p">[</span><span class="n">i_line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]]</span>
                    <span class="c1">#print self.vlength</span>
                <span class="k">if</span> <span class="s2">&quot;in kB&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stress</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">:]]</span>  <span class="c1"># in MPa </span>
                <span class="k">if</span> <span class="s2">&quot;Total  &quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">intstress</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]]</span> <span class="c1">#stress in internal units; can be regarded as forces</span>
                
                <span class="k">if</span> <span class="s2">&quot;external pressure =&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span> 
                    <span class="c1">#print iterat</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">extpress</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span> <span class="c1"># in MPa </span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdstep</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">extpress_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extpress</span>

                <span class="k">if</span> <span class="s2">&quot;E-fermi :&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span> 
                    <span class="c1"># print line</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">efermi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span> <span class="c1"># in eV</span>


                <span class="k">if</span> <span class="s2">&quot;Elapsed time&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">re_nkpts</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">NKPTS</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">if</span> <span class="s2">&quot;WARNING&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">warnings</span> <span class="o">+=</span> <span class="mi">1</span><span class="c1">#line</span>


                <span class="k">if</span> <span class="s2">&quot;Subroutine DYNSYM returns&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">nsgroup</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">]</span><span class="c1">#number of space group operations</span>



                <span class="k">if</span> <span class="s2">&quot;Iteration&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mdstep</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="n">iterat</span> <span class="o">+=</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">mdstep_old</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdstep</span><span class="p">:</span>
                        <span class="c1">#print &quot;Stress:&quot;, self.stress </span>
                        <span class="n">nscflist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">niter</span> <span class="p">)</span> <span class="c1"># add to list number of scf iterations during mdstep_old</span>
                    <span class="n">niter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="c1">#number of scf iteration</span>
                    <span class="n">mdstep_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdstep</span>





                <span class="n">i_line</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1">#Check total drift</span>
            <span class="n">max_magnitude</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">magnitudes</span><span class="p">)</span>
            <span class="n">max_tdrift</span>    <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tdrift</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maxforce</span> <span class="o">=</span> <span class="n">maxforce</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># if max_magnitude &lt; self.set.toldff/10: max_magnitude = self.set.toldff</span>
            <span class="c1"># print &#39;magn&#39;, magnitudes</span>
            <span class="c1"># print &#39;totdr&#39;, tdrift</span>
            <span class="c1"># print &#39;max_magnitude&#39;, max_magnitude</span>
            <span class="c1"># try </span>
            <span class="k">if</span> <span class="n">max_magnitude</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">tolmxf</span><span class="p">:</span> <span class="n">max_magnitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">tolmxf</span>
            <span class="c1">#if any(d &gt; 0.001 and d &gt; max_magnitude for d in tdrift):</span>
            <span class="k">if</span> <span class="n">max_tdrift</span> <span class="o">&gt;</span> <span class="mf">0.001</span> <span class="ow">and</span> <span class="n">max_tdrift</span> <span class="o">&gt;</span> <span class="n">max_magnitude</span><span class="p">:</span>
                
                <span class="c1">#print_and_log( (&quot;Total drift is too high! At the end one component is %0.f %% of the maximum force, check output!\n&quot;) %(maxdrift)  )</span>
                <span class="k">pass</span>
            <span class="c1">#else: maxdrift = </span>
            <span class="c1"># print magn</span>
            <span class="sd">&quot;&quot;&quot;Try to read xred from CONCAR and calculate xcart&quot;&quot;&quot;</span>

            <span class="c1">#correction of bug; Take into account that VASP changes typat by sorting impurities of the same type.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">typat</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">nz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">nznucl</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">typat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1">#correction of bug</span>

            <span class="c1">#print contcar_exist</span>
            <span class="k">if</span> <span class="n">contcar_exist</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_contcar</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">contcar</span><span class="p">:</span>
                    
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">contcar</span><span class="p">:</span>
                        
                        <span class="k">if</span> <span class="s2">&quot;Direct&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">xred</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">):</span>
                                <span class="n">xr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span> <span class="p">(</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">contcar</span><span class="o">.</span><span class="n">next</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">xred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">xr</span> <span class="p">)</span>






                <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">xcart</span> <span class="o">=</span> <span class="n">xred2xcart</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">xred</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">rprimd</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">xred</span> <span class="o">=</span> <span class="n">xcart2xred</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">xcart</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">rprimd</span><span class="p">)</span>

            <span class="c1">#print &quot;init pressure = &quot;,self.extpress_init,&quot;; final pressure =&quot;,self.extpress</span>
            <span class="c1">#print self.end.xred</span>
            <span class="c1">#self.vol = np.dot( self.rprimd[0], np.cross(self.rprimd[1], self.rprimd[2])  ); #volume</span>
            <span class="n">nscflist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">niter</span> <span class="p">)</span> <span class="c1"># add to list number of scf iterations during mdstep_old</span>
            <span class="c1">#print &quot;Stress:&quot;, self.stress</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlength</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stress</span>
            <span class="n">yznormal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">rprimd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="c1">#print yznormal</span>
            <span class="c1">#print np.cross( yznormal, np.array([1,0,0]) )</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gbpos</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span> <span class="n">yznormal</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> 
                    <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Warning! The normal to yz is not parallel to x. Take care of gb area</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">yzarea</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span> <span class="n">yznormal</span> <span class="p">)</span>  <span class="c1">#It is assumed, that boundary is perpendicular to x</span>


            <span class="sd">&quot;&quot;&quot;Calculate voronoi volume&quot;&quot;&quot;</span>
            <span class="c1"># print hasattr(self, &#39;vorovol&#39;)</span>
            <span class="n">voro</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">voronoi</span><span class="p">:</span><span class="c1"># and not hasattr(self, &#39;vorovol&#39;):#out_type == &#39;e_seg&#39;:</span>
                <span class="n">voro</span> <span class="o">=</span> <span class="n">calculate_voronoi</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="n">calculate_voronoi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;init&#39;</span><span class="p">)</span>


            <span class="c1">#  Construct beatifull table</span>
            <span class="c1">#self.a1 = float(v[0])/2 ; self.a2 = float(v[1])/2/math.sqrt(0.75); self.c = float(v[2])  # o1b</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hex_a</span> <span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hex_c</span>  <span class="c1"># c1b</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">a</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#calculations with full relaxation</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">==</span> <span class="p">[</span><span class="bp">None</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">a</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

            <span class="n">d</span> <span class="o">=</span> <span class="s2">&quot;&amp;&quot;</span>
            <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">))</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">etot</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_sigma0</span> <span class="p">))</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># print self.a</span>
            <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span>      <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="p">)</span>      <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span>      <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">)</span>      <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="o">/</span><span class="mf">3600.</span><span class="p">)</span>    <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">itertm</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="o">/</span><span class="mf">1.</span><span class="o">/</span><span class="n">iterat</span><span class="p">)</span>    <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
            <span class="n">Nmd</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%1i</span><span class="s2">,</span><span class="si">%2i</span><span class="s2">,</span><span class="si">%3i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdstep</span><span class="p">,</span> <span class="n">iterat</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">mdstep</span><span class="p">,</span> <span class="n">iterat</span><span class="p">)</span>    <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
            <span class="n">War</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">warnings</span><span class="p">)</span>    <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
            <span class="c1">#nbands = (&quot;%i&quot; % (self.set.vasp_params[&quot;NBANDS&quot;])    ).center(j[8])</span>
            <span class="c1">#added = (&quot;%.0f&quot; % ( (self.set.add_nbands - 1) * 100 )    ).center(j[15])</span>
            <span class="n">kmesh</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">ngkpt</span><span class="p">)</span> <span class="p">)</span>    <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
            <span class="n">ks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_kspacings</span><span class="p">()</span>
            <span class="n">kspacing</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;[</span><span class="si">%.2f</span><span class="s2">,</span><span class="si">%.2f</span><span class="s2">,</span><span class="si">%.2f</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">ks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ks</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ks</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span>    <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
            <span class="n">ks1</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;[</span><span class="si">%.2f</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">ks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>    <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
            <span class="n">nkpt</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">NKPTS</span><span class="p">)</span>     <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span>
            <span class="n">istrs</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;[</span><span class="si">%5i</span><span class="s2">,</span><span class="si">%5i</span><span class="s2">,</span><span class="si">%5i</span><span class="s2">] &quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">intstress</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">intstress</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">intstress</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="p">)</span>    <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">11</span><span class="p">])</span>
            <span class="n">strs</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.0f</span><span class="s2">,</span><span class="si">%.0f</span><span class="s2">,</span><span class="si">%.0f</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">stress</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">stress</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">stress</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="p">)</span>    <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">11</span><span class="p">])</span>   
            <span class="n">eprs</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.0f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extpress</span><span class="p">))</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span>
            <span class="n">tsm</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.0f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">tsmear</span><span class="o">*</span><span class="mi">1000</span><span class="p">))</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">13</span><span class="p">])</span>
            <span class="n">entrr</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>   <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy_free</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_sigma0</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">natom</span> <span class="o">*</span> <span class="mi">1000</span>    <span class="p">)</span>   <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">14</span><span class="p">])</span> <span class="c1">#entropy due to the use of smearing</span>
            <span class="n">npar</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s2">&quot;NPAR&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
            <span class="n">lpl</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s2">&quot;LPLANE&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">17</span><span class="p">])</span>
            <span class="n">ecut</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="o">.</span><span class="n">vasp_params</span><span class="p">[</span><span class="s2">&quot;ENCUT&quot;</span><span class="p">])</span> <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">18</span><span class="p">])</span> 

            <span class="n">lens</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">;</span><span class="si">%.2f</span><span class="s2">;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">19</span><span class="p">])</span>
            <span class="n">r1</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">19</span><span class="p">])</span>            
            <span class="n">vol</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">vol</span> <span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">20</span><span class="p">])</span>
            <span class="n">nat</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span> <span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">21</span><span class="p">])</span>
            <span class="n">totd</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.0f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>   <span class="n">max_tdrift</span><span class="o">/</span><span class="n">max_magnitude</span> <span class="o">*</span> <span class="mi">100</span>      <span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">22</span><span class="p">])</span>
            <span class="n">nsg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>     <span class="n">nsgroup</span>     <span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">22</span><span class="p">])</span>

            <span class="sd">&quot;&quot;&quot;Warning! concentrations are calculated correctly only for cells with one impurity atom&quot;&quot;&quot;</span>
            <span class="c1">#gbcon = (&quot;%.3f&quot; % (     1./self.end.yzarea      ) ).center(j[23]) # surface concentation at GB A-2</span>
            <span class="c1">#bcon = (&quot;%.1f&quot; % (     1./self.natom * 100      ) ).center(j[24]) # volume atomic concentration, %</span>
            <span class="c1">#outstring_nbands = name+d+Etot+d+a+d+c+d+time+d+itertm+d+Nmd+d+War+d+nbands+d+added+&quot;\\\\&quot;</span>
            <span class="c1">#outstring_npar = name+d+Etot+d+a+d+c+d+time+d+itertm+d+Nmd+d+War+d+npar+d+lpl+&quot;\\\\&quot;</span>

            <span class="c1">#outstring_stress = name+d+Etot+d+a+d+c+d+time+d+itertm+d+Nmd+d+War+d+istrs+d+eprs</span>

            <span class="c1">#outstring_kp_ec = name+d+Etot+d+a+d+c+d+time+d+itertm+d+Nmd+d+War+d+strs+d+eprs+d+kmesh+d+ecut+&quot;\\\\&quot;</span>
            <span class="n">outst_ecut</span><span class="o">=</span> <span class="n">etot</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">c</span><span class="o">+</span>                                            <span class="n">d</span><span class="o">+</span><span class="n">time</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">itertm</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">Nmd</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">War</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">ecut</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span>
            <span class="n">outst_kp</span>  <span class="o">=</span> <span class="n">etot</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">c</span><span class="o">+</span>                                            <span class="n">d</span><span class="o">+</span><span class="n">time</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">itertm</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">Nmd</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">War</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">kmesh</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">kspacing</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">nkpt</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span>            
            <span class="n">outst_ts</span>  <span class="o">=</span> <span class="n">etot</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">c</span><span class="o">+</span>                                            <span class="n">d</span><span class="o">+</span><span class="n">time</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">itertm</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">Nmd</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">War</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">kmesh</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">tsm</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">entrr</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span>

            <span class="n">outst_all</span> <span class="o">=</span> <span class="n">voro</span><span class="o">+</span><span class="n">etot</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">lens</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">vol</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">kspacing</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">strs</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">eprs</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">nat</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">time</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">Nmd</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">War</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">totd</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">nsg</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span>
            <span class="n">outst_seg</span> <span class="o">=</span> <span class="n">voro</span><span class="o">+</span><span class="n">etot</span><span class="o">+</span><span class="n">d</span><span class="o">+</span>        <span class="n">lens</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">vol</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">ks1</span>     <span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">strs</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">eprs</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">nat</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">time</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">Nmd</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">War</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">totd</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">nsg</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span> <span class="c1">#for segregation</span>
            <span class="n">outst_coseg</span><span class="o">=</span><span class="n">voro</span><span class="o">+</span><span class="n">etot</span><span class="o">+</span><span class="n">d</span><span class="o">+</span>                                <span class="n">strs</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">eprs</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">nat</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">time</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">Nmd</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">War</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">totd</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">nsg</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span> <span class="c1">#for co-segregation; </span>
            <span class="n">outst_gbe</span> <span class="o">=</span> <span class="n">voro</span><span class="o">+</span><span class="n">etot</span><span class="o">+</span>               <span class="n">d</span><span class="o">+</span><span class="n">vol</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">kspacing</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">strs</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">eprs</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">nat</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">time</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">Nmd</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">War</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">nsg</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span> <span class="c1"># For comparing gb energies and volume</span>
            <span class="n">outst_imp</span> <span class="o">=</span> <span class="n">voro</span><span class="o">+</span><span class="n">etot</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">lens</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">vol</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">kspacing</span><span class="o">+</span><span class="n">d</span><span class="o">+</span>       <span class="n">eprs</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">nat</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">time</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">Nmd</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">War</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">totd</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="n">nsg</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span> <span class="c1"># For comparing impurity energies</span>
                        
            <span class="c1"># print self.end.xred[-1]</span>
            <span class="c1">#print outstring_kp_ec</span>
            <span class="k">if</span> <span class="s1">&#39;force&#39;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;Maxforce by md steps (meV/A) = </span><span class="si">%s</span><span class="s2">;&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">maxforce</span><span class="p">)</span>  <span class="p">)</span>
                <span class="k">print</span> <span class="s2">&quot;Avforce by md steps = </span><span class="si">%s</span><span class="s2">;&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">average</span><span class="p">)</span>  <span class="p">)</span>

            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Reading of results completed</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">if</span>   <span class="n">out_type</span> <span class="o">==</span> <span class="s1">&#39;gbe&#39;</span>  <span class="p">:</span> <span class="n">outst</span> <span class="o">=</span> <span class="n">outst_gbe</span>
            <span class="k">elif</span> <span class="n">out_type</span> <span class="o">==</span> <span class="s1">&#39;e_imp&#39;</span><span class="p">:</span> <span class="n">outst</span> <span class="o">=</span> <span class="n">outst_imp</span>
            <span class="k">elif</span> <span class="n">out_type</span> <span class="o">==</span> <span class="s1">&#39;e_seg&#39;</span><span class="p">:</span> <span class="n">outst</span> <span class="o">=</span> <span class="n">outst_seg</span>            
            <span class="k">elif</span> <span class="n">out_type</span> <span class="o">==</span> <span class="s1">&#39;coseg&#39;</span><span class="p">:</span> <span class="n">outst</span> <span class="o">=</span> <span class="n">outst_coseg</span>            
            <span class="k">elif</span> <span class="s1">&#39;ecut&#39;</span> <span class="ow">in</span> <span class="n">out_type</span> <span class="p">:</span> <span class="n">outst</span> <span class="o">=</span> <span class="n">outst_ecut</span>
            <span class="k">elif</span> <span class="s1">&#39;kp&#39;</span> <span class="ow">in</span> <span class="n">out_type</span>   <span class="p">:</span> <span class="n">outst</span> <span class="o">=</span> <span class="n">outst_kp</span>
            <span class="k">elif</span> <span class="s1">&#39;ts&#39;</span> <span class="ow">in</span> <span class="n">out_type</span>   <span class="p">:</span> <span class="n">outst</span> <span class="o">=</span> <span class="n">outst_ts</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">outst</span> <span class="o">=</span> <span class="n">outst_all</span>
            <span class="c1">#else: print_and_log(&quot;Uknown type of outstring\n&quot;)</span>




            <span class="k">return</span> <span class="n">outst</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">print_and_log</span><span class="p">(</span><span class="s2">&quot;Still no OUTCAR for mystery reason</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># raise RuntimeError</span>

    <span class="k">def</span> <span class="nf">get_chg_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filetype</span> <span class="o">=</span> <span class="s1">&#39;CHGCAR&#39;</span><span class="p">):</span>
        <span class="c1">#cl - object of CalculationVasp class</span>
        <span class="n">path_to_chg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="o">+</span><span class="n">filetype</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_chg</span><span class="p">):</span> 
            <span class="k">print</span> <span class="s1">&#39;Charge file is downloading&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">runBash</span><span class="p">(</span><span class="s2">&quot;rsync -zave ssh &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_address</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path_cluster</span><span class="o">+</span><span class="n">path_to_chg</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="p">)</span> <span class="c1">#CHG</span>
            <span class="k">print</span> <span class="n">path_to_chg</span><span class="p">,</span> <span class="s1">&#39;was downloaded&#39;</span>
            
        <span class="k">return</span> <span class="n">path_to_chg</span>

    <span class="k">def</span> <span class="nf">get_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="c1">#cl - object of CalculationVasp class</span>
        <span class="c1"># filename - standart Vasp file name</span>
        <span class="n">path_to_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="o">+</span><span class="n">filename</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">):</span> 
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">runBash</span><span class="p">(</span><span class="s2">&quot;rsync -zave ssh &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_address</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path_cluster</span><span class="o">+</span><span class="n">path_to_file</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="p">)</span> <span class="c1">#CHG</span>
            <span class="k">print</span> <span class="n">path_to_file</span><span class="p">,</span> <span class="s1">&#39;was downloaded&#39;</span>
            
        <span class="k">return</span> <span class="n">path_to_file</span>


    <span class="k">def</span> <span class="nf">bader_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#Make bader on server</span>
        <span class="c1">#assumes that bader is intalled</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">project_path_cluster</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span>
        <span class="n">CHG</span>     <span class="o">=</span> <span class="n">path</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s2">&quot;.CHG&quot;</span>
        <span class="n">AECCAR0</span> <span class="o">=</span> <span class="n">path</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s2">&quot;.AECCAR0&quot;</span>
        <span class="n">AECCAR2</span> <span class="o">=</span> <span class="n">path</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s2">&quot;.AECCAR2&quot;</span>
        <span class="n">CHGCAR_sum</span> <span class="o">=</span> <span class="n">path</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s2">&quot;.CHGCAR_sum&quot;</span>
        <span class="n">baderlog</span> <span class="o">=</span>  <span class="n">path</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s2">&quot;.bader.log&quot;</span>
        <span class="n">command1</span> <span class="o">=</span> <span class="s2">&quot;cd &quot;</span><span class="o">+</span><span class="n">path</span><span class="o">+</span><span class="s2">&quot;; ~/utils/chgsum.pl &quot;</span><span class="o">+</span><span class="n">AECCAR0</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="n">AECCAR2</span><span class="o">+</span><span class="s2">&quot;; &quot;</span><span class="o">+</span>\
        <span class="s2">&quot;mv CHGCAR_sum &quot;</span><span class="o">+</span><span class="n">CHGCAR_sum</span><span class="o">+</span><span class="s2">&quot;;&quot;</span>
        <span class="n">command2</span> <span class="o">=</span> \
        <span class="s2">&quot;cd &quot;</span><span class="o">+</span><span class="n">path</span><span class="o">+</span><span class="s2">&quot;; ~/utils/bader &quot;</span><span class="o">+</span><span class="n">CHG</span><span class="o">+</span><span class="s2">&quot; -ref &quot;</span><span class="o">+</span><span class="n">CHGCAR_sum</span><span class="o">+</span><span class="s2">&quot; &gt; &quot;</span><span class="o">+</span>\
        <span class="n">v</span><span class="o">+</span><span class="s2">&quot;.bader.log; mv ACF.dat &quot;</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s2">&quot;.ACF.dat; mv AVF.dat &quot;</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s2">&quot;.AVF.dat; mv BCF.dat &quot;</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s2">&quot;.BCF.dat;&quot;</span>
        <span class="c1"># print &quot;ssh &quot;+cluster_address+&quot; &#39;&quot;+command1+&quot;&#39;&quot;</span>
        
        <span class="k">if</span> <span class="n">runBash</span><span class="p">(</span><span class="s2">&quot;ssh &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_address</span><span class="o">+</span><span class="s2">&quot; &#39;[ -e &quot;</span><span class="o">+</span>   <span class="n">CHGCAR_sum</span>       <span class="o">+</span><span class="s2">&quot;&quot;&quot; ] || echo &quot;NO&quot;     ;&#39; &quot;&quot;&quot;</span><span class="p">):</span> <span class="c1">#true if file not exists</span>
            <span class="k">print</span>  <span class="n">CHGCAR_sum</span><span class="p">,</span> <span class="s2">&quot;not exist. try to calculate it &quot;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">runBash</span><span class="p">(</span><span class="s2">&quot;ssh &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_address</span><span class="o">+</span><span class="s2">&quot; &#39;&quot;</span><span class="o">+</span><span class="n">command1</span><span class="o">+</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="p">)</span> 
        
        <span class="k">if</span> <span class="n">runBash</span><span class="p">(</span><span class="s2">&quot;ssh &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_address</span><span class="o">+</span><span class="s2">&quot; &#39;[ -e &quot;</span><span class="o">+</span>   <span class="n">baderlog</span>       <span class="o">+</span><span class="s2">&quot;&quot;&quot; ] || echo &quot;NO&quot;     ;&#39; &quot;&quot;&quot;</span><span class="p">):</span> <span class="c1">#true if file not exists</span>
            <span class="k">print</span>  <span class="n">baderlog</span><span class="p">,</span> <span class="s2">&quot;not exist. try to calculate Bader &quot;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">runBash</span><span class="p">(</span><span class="s2">&quot;ssh &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_address</span><span class="o">+</span><span class="s2">&quot; &#39;&quot;</span><span class="o">+</span><span class="n">command2</span><span class="o">+</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="p">)</span> 
        <span class="n">ACF</span> <span class="o">=</span> <span class="n">runBash</span><span class="p">(</span><span class="s2">&quot;ssh &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_address</span><span class="o">+</span><span class="s2">&quot; &#39;cat &quot;</span><span class="o">+</span><span class="n">path</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s2">&quot;.ACF.dat&quot;</span>  <span class="o">+</span><span class="s2">&quot;&#39;&quot;</span> <span class="p">)</span>
        <span class="c1"># print ACF</span>
        <span class="n">ACF</span> <span class="o">=</span> <span class="n">ACF</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">2</span><span class="p">:]</span> <span class="c1">#list of lines with charges for each atom</span>

        <span class="c1"># print ACF[0]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">znucl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">imp_valence_chg</span> <span class="o">=</span> <span class="mi">6</span> <span class="c1">#!!should be taken from potential</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">znucl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">imp_valence_chg</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1">#!!should be taken from potential</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">znucl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">22</span><span class="p">:</span>
            <span class="n">mat_valence_chg</span> <span class="o">=</span> <span class="mi">12</span> <span class="c1">#!!should be taken from potential</span>



        <span class="n">local_atoms</span> <span class="o">=</span> <span class="n">local_surrounding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xcart</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">control</span> <span class="o">=</span> <span class="s1">&#39;atoms&#39;</span><span class="p">)</span>
        <span class="n">numbers</span> <span class="o">=</span> <span class="n">local_atoms</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># first atom is impurity</span>
        <span class="k">print</span> <span class="n">numbers</span>
        <span class="n">imp_partial_chg</span> <span class="o">=</span> <span class="n">imp_valence_chg</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">ACF</span><span class="p">[</span><span class="n">numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">])</span>

        <span class="n">mat_partial_chg</span> <span class="o">=</span> <span class="p">[</span><span class="n">mat_valence_chg</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">ACF</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numbers</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="p">]</span>
        <span class="k">print</span> <span class="s2">&quot;Partial charge of impurity &quot;</span><span class="p">,</span> <span class="n">imp_partial_chg</span>
        <span class="k">print</span> <span class="s2">&quot;Partial charges of neibouring Ti atoms&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;{:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mat_partial_chg</span><span class="p">)</span>
        <span class="k">print</span> <span class="s2">&quot;Partial charge of matrix&quot;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mat_partial_chg</span><span class="p">)</span>
        
        <span class="k">print</span> <span class="s2">&quot;Sum of mat and imp charges:&quot;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mat_partial_chg</span><span class="p">)</span><span class="o">+</span><span class="n">imp_partial_chg</span>

        <span class="k">return</span> <span class="n">path_to_chg</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Dmitry Aksenov.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.7</a>
      
    </div>

    

    
  </body>
</html>